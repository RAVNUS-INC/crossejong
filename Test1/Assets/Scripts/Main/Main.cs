using UnityEngine;
using UnityEngine.UI;
using PlayFab;
using PlayFab.ClientModels;
using Photon.Pun;
using static UnityEngine.EventSystems.EventTrigger;
using UnityEngine.SceneManagement;
using System;

// 메인에 존재하는 기능에 관한 스크립트
public class Main : MonoBehaviour
{

    //usersetmanager에서 가져온 변수들    
    private InputField inputField; //프로필 패널 안의 이름입력필드
    private Text SaveText; //프로필 패널 안의 저장메시지
    private Sprite[] ProfileImg; //프로필 이미지 배열
    private Image ProfileCenImg; //프로필 패널 중심 이미지

    // --------------메인에 보여질 오브젝트------------------
    public Text displayNameText; // DisplayName을 표시할 UI 텍스트
    public Image centralImage;  // 메인 프로필 이미지
    public GameObject profilePanel; // 프로필 수정 패널

    // ---------------대시보드에 보여질 랭킹 오브젝트---------------
    public GameObject[] ranklist; //활성화/비활성화를 위한 오브젝트
    public Image[] userimage; //유저 이미지
    public Text[] username; //유저 이름
    public Text[] wordcount; //단어완성횟수

    public Text TestText, LogTestText; //빌드 테스트 텍스트 상태, 로그아웃 텍스트 상태
    private const string DISPLAYNAME_KEY = "DisplayName"; // 유저의 DisplayName
    private const string IMAGEINDEX_KEY = "ImageIndex"; // 유저의 이미지 인덱스
    private const string PROFILE_IMAGE_INDEX_KEY = "ProfileImageIndex";  // 저장 키

    private void Awake()
    {
        // UserSetManager 컴포넌트 참조
        UserSetManager userSetManager = FindObjectOfType<UserSetManager>();

        // UserSetManager에서 InputField를 가져옴
        inputField = userSetManager.inputText;
        SaveText = userSetManager.saveText;
        ProfileImg = userSetManager.profileImages; //프로필 이미지 배열
        ProfileCenImg = userSetManager.centralImage; //프로필 패널 중심사진
    }

    void Start()
    {
        if (PhotonNetwork.InLobby)
        {
            Debug.Log("현재 로비에 있음.");
        }
        else
        {
            Debug.Log("현재 로비에 없음.");
            PhotonNetwork.JoinLobby();  // 로비로 이동
        }

        profilePanel.SetActive(false); //프로필 패널 비활성화

        GetProfileImageIndex(); // PlayFab에서 저장된 이미지 인덱스를 불러와 이미지 업데이트
        GetUserDisplayName(); //유저 네임 불러와서 텍스트로 표시

        RankActiveFalse(); //순위 오브젝트 모두 비활성화
        GetLeaderBoard(); //순위 업데이트
    }


    // 프로필 이미지 인덱스 불러오기 함수
    private void GetProfileImageIndex()
    {
        int imageIndex = PlayerPrefs.GetInt(IMAGEINDEX_KEY, 0);
        centralImage.sprite = ProfileImg[imageIndex]; //메인 유저 이미지 교체
        ProfileCenImg.sprite = ProfileImg[imageIndex]; //프로필 패널 중심 이미지 교체

        TestText.text = "이미지 로딩 완료";
    }
    

    // DisplayName 불러오기 함수
    public void GetUserDisplayName()
    {
        string displayName = PlayerPrefs.GetString(DISPLAYNAME_KEY, "Guest");
        displayNameText.text = displayName; //메인 패널 이름
        inputField.text = displayName; //프로필 패널 이름

        TestText.text = "DisplayName 로딩 완료";
    }

    //프로필 패널의 닫기 버튼을 누르면(닫기 버튼에 연결해둠)
    public void ExitBtn() 
    {
        profilePanel.SetActive(false); //패널 비활성화
        inputField.interactable = false; //이름입력란 비활성화
        SaveText.text = ""; //저장 메시지 초기화

        //유저 프로필 이미지 재로드, 이름 재로드 텍스트 보여주기
        GetUserDisplayName();
        GetProfileImageIndex();

    }

    // 로그아웃 버튼을 누르면->playfab 인증을 로그아웃
    public void LogoutBtn()
    {
        // 서버와의 연결도 끊기
        if (PhotonNetwork.IsConnected)
        {
            PhotonNetwork.Disconnect(); // 현재 연결 끊기
        }

        // 안드로이드 기기 ID도 연동 해제
        PlayFabClientAPI.UnlinkAndroidDeviceID(new UnlinkAndroidDeviceIDRequest(), result =>
        {
            Debug.Log("기기 ID 연동 해제 성공");

            // PlayFab 인증 정보 초기화
            PlayFabClientAPI.ForgetAllCredentials();
            LogTestText.text = "기기 및 playfab 해제";

            //로딩바 ui 애니메이션 보여주기(Login씬으로 이동)
            LoadingSceneController.Instance.LoadScene("Login");
        },
        error =>
        {
            Debug.LogError("기기 ID 연동 해제 실패: " + error.GenerateErrorReport());
            LogTestText.text = "기기 ID 연동 해제 실패";
        });

        

        //Debug.Log("로그아웃되었습니다. 인증 정보가 초기화되었습니다.");
    }

    // 게임 종료 버튼을 누르면
    public void ExitGame()
    {
        Debug.Log("게임 종료"); // Unity 에디터에서 디버그 메시지 확인
        Application.Quit(); // 실제로 게임 종료

        //Debug.Log("게임 종료");
        //#if UNITY_EDITOR
        //        UnityEditor.EditorApplication.isPlaying = false; // 에디터 종료
        //#else
        //    Application.Quit(); // 빌드된 게임 종료
        //#endif
    }

    //모든 순위오브젝트 비활성화 시키기
    private void RankActiveFalse()
    {
        for (int i = 0; i < ranklist.Length; i++)
        {
            ranklist[i].SetActive(false);
        }
    }

    //유저가 리더보드 업데이트 버튼을 누르면
    public void UpdateBtn()
    {
        //순위오브젝트 비활성화
        RankActiveFalse();
        //유저들 간의 순위를 재갱신
        GetLeaderBoard();

    }

    // 리더보드 리스트에 들어갈 정보 불러오기
    public void GetLeaderBoard()
    {
        // playfab에서 리더보드 정보 요청
        var request = new GetLeaderboardRequest 
        { StartPosition = 0, StatisticName = "WordCompletionCount", MaxResultsCount = 10, 
          ProfileConstraints = new PlayerProfileViewConstraints() { ShowDisplayName = true } };
        PlayFabClientAPI.GetLeaderboard(request, (result) =>
        {
            for (int i = 0; i < result.Leaderboard.Count; i++)
            {
                var curBoard = result.Leaderboard[i];
                //유저수, 순위에 따른 오브젝트 활성화
                ranklist[i].SetActive(true);
                //유저 단어완성횟수 업데이트
                wordcount[i].text = "총 " + curBoard.StatValue.ToString() + "회";
                //유저 이름 업데이트
                username[i].text = curBoard.DisplayName;
                //유저 이미지 인덱스를 요청 및 업데이트
                GetUserImageData(curBoard.PlayFabId, i);
            }
        },
        (Error) => print("리더보드 불러오기 실패"));
    }

    // 특정 유저의 공개 데이터 요청 함수(playfab으로부터)
    private void GetUserImageData(string playFabId, int index)
    {
        var userDataRequest = new GetUserDataRequest
        {
            PlayFabId = playFabId // 데이터를 가져올 유저의 PlayFabId
        };
        PlayFabClientAPI.GetUserData(userDataRequest, result =>
        {
            // PROFILE_IMAGE_INDEX_KEY가 존재하는지 확인
            if (result.Data.ContainsKey(PROFILE_IMAGE_INDEX_KEY))
            {
                // 저장된 인덱스 값 불러오기
                int imgindex = int.Parse(result.Data[PROFILE_IMAGE_INDEX_KEY].Value);
                // 인덱스 범위 체크 후 랭킹 유저 이미지 업데이트
                userimage[index].sprite = ProfileImg[imgindex];
            }
            else
            {
                Debug.LogWarning("PROFILE_IMAGE_INDEX_KEY가 존재하지 않습니다. 기본 이미지로 설정합니다.");
                userimage[index].sprite = ProfileImg[0];  // 기본 이미지로 설정
            }
        }, error =>
        {
            Debug.LogError($"유저 데이터 불러오기 실패: {error.GenerateErrorReport()}");
        });
    }

}
